name: cipher challenge bot

on:
  issues:
    types: [opened]

jobs:
  solve_cipher:
    if: startsWith(github.event.issue.title, 'Atbash Solution:')
    runs-on: ubuntu-latest
    
    # Permissions remain the same
    permissions:
      contents: write 
      issues: write   

    # ðŸ’¡ NEW: Set the secret as an environment variable for the entire job
    env:
      CIPHER_SOLUTION_CLEAN: ${{ secrets.CIPHER_SOLUTION }}

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Run Cipher Verification Script
        # IMPORTANT: Pass the job's env variable into the run step. 
        # This is where the Python script reads the secret from.
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          CIPHER_SOLUTION: ${{ secrets.CIPHER_SOLUTION }} # Still needed for Python script

        # Note: The Python script needs the CIPHER_SOLUTION defined locally 
        # as it is a required part of the script's logic.
        run: python src/check_cipher.py
        
      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ðŸ¤– BOT: Atbash Cipher Solved! Congrats @${{ github.event.issue.user.login }}'
          
      - name: Close Issue on Success
        if: success()
        # ðŸ’¡ FIX: Using the highly reliable peter-evans action instead
        uses: peter-evans/close-issue@v3 
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: |
            âœ… **CORRECT!** The secret phrase was: **${{ env.CIPHER_SOLUTION_CLEAN }}**
            
            The GitHub README has been updated to feature you as the winner!
          # Ensure you use 'closed' state here
          issue-state: closed
