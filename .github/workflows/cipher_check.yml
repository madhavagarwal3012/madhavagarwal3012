name: Cipher Challenge Bot

on:
  issues:
    types: [opened]

jobs:
  solve_cipher:
    # Only run the job if the issue title starts with our expected format
    if: startsWith(github.event.issue.title, 'Atbash Solution:')
    runs-on: ubuntu-latest
    
    # Permissions are crucial for committing the README change and closing the issue
    permissions:
      contents: write 
      issues: write   

    # ðŸ’¡ FIX: Set the secret as an environment variable for the entire job 
    # to be used securely in the final comment.
    env:
      CIPHER_SOLUTION_CLEAN: ${{ secrets.CIPHER_SOLUTION }}

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Run Cipher Verification Script
        # ðŸ’¡ FIX: Added ID to reference this step's outcome for conditional running
        id: verification 
        # Pass the issue data and the SECRET to the Python script
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          CIPHER_SOLUTION: ${{ secrets.CIPHER_SOLUTION }} # Passes the secret securely
        # The Python script must now include 'import re' and use 'exit(1)' on failure
        run: python src/check_cipher.py
        
      - name: Commit and Push Changes
        # ðŸ’¡ FIX: Only run if the verification script succeeded (non-zero exit code means failure)
        if: success() && steps.verification.outcome == 'success'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ðŸ¤– BOT: Atbash Cipher Solved! Congrats @${{ github.event.issue.user.login }}'
          
      - name: Close Issue on Success
        # ðŸ’¡ FIX: Only run if the verification script succeeded 
        if: success() && steps.verification.outcome == 'success'
        uses: peter-evans/close-issue@v3 
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: |
            âœ… **CORRECT!** The secret phrase was: **${{ env.CIPHER_SOLUTION_CLEAN }}**
            
            The GitHub README has been updated to feature you as the winner!
          # ðŸ’¡ FIX: 'close-reason' is the correct parameter name for this action
          close-reason: completed
